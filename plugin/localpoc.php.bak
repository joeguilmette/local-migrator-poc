<?php
/**
 * Plugin Name: Local Migrator
 * Plugin URI: https://example.com/localpoc
 * Description: Exposes an API for downloading WordPress sites via a local CLI utility.
 * Version: 0.1.0
 * Author: Your Name
 * Author URI: https://example.com
 * License: GPL v2 or later
 * License URI: https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain: localpoc
 */

// Exit if accessed directly
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Main plugin class
 */
class LocalPOC_Plugin {

    /**
     * Option name for storing the access key
     */
    const OPTION_ACCESS_KEY = 'localpoc_access_key';

    /** Initializes plugin hooks. */
    public static function init() {
        // Generate access key on first run
        add_action('plugins_loaded', [__CLASS__, 'ensure_access_key']);

        // Register admin menu
        add_action('admin_menu', [__CLASS__, 'register_admin_menu']);

        // Register AJAX endpoints (logged-in + unauthenticated)
        add_action('wp_ajax_localpoc_files_manifest', 'localpoc_ajax_files_manifest');
        add_action('wp_ajax_nopriv_localpoc_files_manifest', 'localpoc_ajax_files_manifest');

        add_action('wp_ajax_localpoc_file', 'localpoc_ajax_file');
        add_action('wp_ajax_nopriv_localpoc_file', 'localpoc_ajax_file');

        add_action('wp_ajax_localpoc_files_batch_zip', 'localpoc_ajax_files_batch_zip');
        add_action('wp_ajax_nopriv_localpoc_files_batch_zip', 'localpoc_ajax_files_batch_zip');

        add_action('wp_ajax_localpoc_db_stream', 'localpoc_ajax_db_stream');
        add_action('wp_ajax_nopriv_localpoc_db_stream', 'localpoc_ajax_db_stream');

        add_action('wp_ajax_localpoc_db_meta', 'localpoc_ajax_db_meta');
        add_action('wp_ajax_nopriv_localpoc_db_meta', 'localpoc_ajax_db_meta');

        add_action('wp_ajax_localpoc_job_init', 'localpoc_ajax_job_init');
        add_action('wp_ajax_nopriv_localpoc_job_init', 'localpoc_ajax_job_init');

        add_action('wp_ajax_localpoc_job_finish', 'localpoc_ajax_job_finish');
        add_action('wp_ajax_nopriv_localpoc_job_finish', 'localpoc_ajax_job_finish');

        // Register REST route for compatibility
        add_action('rest_api_init', 'localpoc_register_rest_routes');
    }

    /** Ensures an access key exists for the site. */
    public static function ensure_access_key() {
        if (!get_option(self::OPTION_ACCESS_KEY)) {
            $access_key = wp_generate_password(32, false);
            update_option(self::OPTION_ACCESS_KEY, $access_key);
        }
    }

    /** Retrieves the stored access key. */
    public static function get_access_key() {
        return (string) get_option(self::OPTION_ACCESS_KEY, '');
    }

    /** Registers the admin settings page. */
    public static function register_admin_menu() {
        add_menu_page(
            'Local Migrator',                  // Page title
            'Local Migrator',                  // Menu title
            'manage_options',                  // Capability
            'localpoc-downloader',             // Menu slug
            [__CLASS__, 'render_admin_page'],  // Callback
            'dashicons-download',              // Icon
            80                                 // Position
        );
    }

    /** Renders the admin settings page. */
    public static function render_admin_page() {
        if (!current_user_can('manage_options')) {
            wp_die(__('You do not have sufficient permissions to access this page.'));
        }

        $access_key = self::get_access_key();
        $site_url = site_url();
        $cli_command = sprintf(
            'localpoc download --url="%s" --key="%s" --output="./local-backup"',
            esc_attr($site_url),
            esc_attr($access_key)
        );

        ?>
        <div class="wrap">
            <h1>Local Migrator</h1>

            <div style="max-width: 800px;">
                <h2>Connection Details</h2>

                <table class="form-table">
                    <tr>
                        <th scope="row">
                            <label for="site-url">Site URL</label>
                        </th>
                        <td>
                            <input
                                type="text"
                                id="site-url"
                                class="regular-text"
                                value="<?php echo esc_attr($site_url); ?>"
                                readonly
                            />
                            <p class="description">The base URL of this WordPress site.</p>
                        </td>
                    </tr>

                    <tr>
                        <th scope="row">
                            <label for="access-key">Access Key</label>
                        </th>
                        <td>
                            <input
                                type="text"
                                id="access-key"
                                class="regular-text"
                                value="<?php echo esc_attr($access_key); ?>"
                                readonly
                            />
                            <p class="description">Your unique access key for CLI authentication.</p>
                        </td>
                    </tr>
                </table>

                <h2>CLI Command</h2>
                <p>Copy and run this command on your local machine (requires CLI tool installed):</p>

                <div style="background: #f5f5f5; padding: 15px; border-left: 4px solid #2271b1; margin: 20px 0;">
                    <code style="display: block; word-wrap: break-word; white-space: pre-wrap;"><?php echo esc_html($cli_command); ?></code>
                </div>

                <p>
                    <button
                        type="button"
                        class="button button-secondary"
                        onclick="navigator.clipboard.writeText('<?php echo esc_js($cli_command); ?>').then(() => alert('Command copied to clipboard!'))"
                    >
                        Copy Command
                    </button>
                </p>

                <hr style="margin: 30px 0;" />

                <h2>Next Steps</h2>
                <ol>
                    <li>Install the Local Site Downloader CLI tool on your local machine</li>
                    <li>Copy the command above</li>
                    <li>Run it in your terminal to download this WordPress site</li>
                </ol>
            </div>
        </div>
        <?php
    }
}

/** Returns the stored access key globally. */
function localpoc_get_access_key() {
    return LocalPOC_Plugin::get_access_key();
}

/** Determines if a relative path should be excluded. */
function localpoc_should_exclude_path($relative_path, $is_dir = false) {
    $relative = ltrim(str_replace('\\', '/', $relative_path), '/');
    if ($relative === '') {
        return false;
    }

    $basename = basename($relative);

    if (!$is_dir) {
        $file_patterns = ['*.log', '*.tmp', '*.bak', '*.swp'];
        foreach ($file_patterns as $pattern) {
            if (fnmatch($pattern, $basename)) {
                return true;
            }
        }

        if ($basename === '.DS_Store' || str_starts_with($basename, '.~')) {
            return true;
        }
    }

    $relative_lower = strtolower($relative);
    $dir_prefixes = [
        'wp-content/cache',
        'wp-content/uploads/cache',
        'wp-content/updraft',
        'wp-content/ai1wm-backups',
        'wp-content/backups',
    ];
    foreach ($dir_prefixes as $prefix) {
        if (strpos($relative_lower, $prefix) === 0) {
            return true;
        }
    }

    $top = strtolower(explode('/', $relative_lower)[0]);
    if (in_array($top, ['.git', '.svn', '.hg', 'node_modules'], true)) {
        return true;
    }

    // vendor directories under wp-content/plugins|themes/*/vendor
    $segments = explode('/', $relative_lower);
    if (count($segments) >= 4 && $segments[0] === 'wp-content' && in_array($segments[1], ['plugins', 'themes'], true)) {
        if ($segments[3] === 'vendor' || $segments[2] === 'vendor') {
            return true;
        }
    }

    return false;
}


/** Validates a provided access key string. */
function localpoc_validate_access_key($provided_key) {
    $expected_key = localpoc_get_access_key();

    if (empty($provided_key) || !hash_equals($expected_key, $provided_key)) {
        return new WP_Error(
            'localpoc_forbidden',
            __('Invalid access key.', 'localpoc'),
            ['status' => 403]
        );
    }

    return true;
}

/** Retrieves the key from the request headers or params. */
function localpoc_get_request_key() {
    $header_key = '';
    if (isset($_SERVER['HTTP_X_LOCALPOC_KEY'])) {
        $header_key = sanitize_text_field(wp_unslash($_SERVER['HTTP_X_LOCALPOC_KEY']));
    } elseif (function_exists('getallheaders')) {
        $headers = getallheaders();
        if (isset($headers['X-Localpoc-Key'])) {
            $header_key = sanitize_text_field(wp_unslash($headers['X-Localpoc-Key']));
        }
    }

    if (!empty($header_key)) {
        return $header_key;
    }

    if (isset($_REQUEST['localpoc_key'])) { // phpcs:ignore WordPress.Security.NonceVerification
        return sanitize_text_field(wp_unslash($_REQUEST['localpoc_key']));
    }

    return '';
}

/** Sends a JSON error response and exits. */
function localpoc_ajax_send_error(WP_Error $error) {
    $status = $error->get_error_data('status');
    if ($status) {
        status_header((int) $status);
    }

    wp_send_json([
        'error'   => $error->get_error_code(),
        'message' => $error->get_error_message(),
    ]);
}

function localpoc_get_json_body() {
    $raw = file_get_contents('php://input');
    if ($raw === false) {
        return new WP_Error(
            'localpoc_bad_request',
            __('Unable to read request body.', 'localpoc'),
            ['status' => 400]
        );
    }

    $data = json_decode($raw, true);
    if (json_last_error() !== JSON_ERROR_NONE) {
        return new WP_Error(
            'localpoc_bad_json',
            __('Invalid JSON payload.', 'localpoc'),
            ['status' => 400]
        );
    }

    return $data;
}

function localpoc_normalize_pagination($offset, $limit) {
    $offset = max(0, (int) $offset);
    $limit = (int) $limit;
    if ($limit <= 0) {
        $limit = 5000;
    }
    $limit = min($limit, 20000);

    return [$offset, $limit];
}

function localpoc_scan_file_list() {
    $root_path = function_exists('untrailingslashit') ? untrailingslashit(ABSPATH) : rtrim(ABSPATH, '/\\');
    $files = [];

    $directory_iterator = new RecursiveDirectoryIterator(
        $root_path,
        FilesystemIterator::SKIP_DOTS
    );

    $filtered_iterator = new RecursiveCallbackFilterIterator(
        $directory_iterator,
        function ($current) use ($root_path) {
            $full_path = $current->getPathname();
            $relative = ltrim(str_replace('\\', '/', substr($full_path, strlen($root_path))), '/');
            return !localpoc_should_exclude_path($relative, $current->isDir());
        }
    );

    $iterator = new RecursiveIteratorIterator(
        $filtered_iterator,
        RecursiveIteratorIterator::LEAVES_ONLY
    );

    foreach ($iterator as $file_info) {
        if (!$file_info->isFile() || !$file_info->isReadable()) {
            continue;
        }

        $full_path = $file_info->getPathname();
        $relative = ltrim(str_replace('\\', '/', substr($full_path, strlen($root_path))), '/');
        if (localpoc_should_exclude_path($relative)) {
            continue;
        }

        $files[] = [
            'path'  => $relative,
            'size'  => (int) $file_info->getSize(),
            'mtime' => (int) $file_info->getMTime(),
        ];
    }

    return $files;
}

function localpoc_generate_manifest($offset, $limit) {
    $files = localpoc_scan_file_list();

    $total = count($files);
    $total_bytes = array_sum(array_column($files, 'size'));
    $slice = array_slice($files, $offset, $limit);

    return [
        'root'        => ABSPATH,
        'offset'      => $offset,
        'limit'       => $limit,
        'total_files' => $total,
        'files'       => array_values($slice),
        'total_bytes' => $total_bytes,
        'all_files'   => $files,
    ];
}

function localpoc_save_job(array $files) {
    $job_id = wp_generate_password(20, false, false);
    $payload = [
        'created_at'   => time(),
        'files'        => $files,
        'total_files'  => count($files),
        'total_bytes'  => array_sum(array_column($files, 'size')),
    ];
    set_transient('localpoc_job_' . $job_id, $payload, 15 * MINUTE_IN_SECONDS);
    return $job_id;
}

function localpoc_get_job($job_id) {
    $data = get_transient('localpoc_job_' . $job_id);
    if (!is_array($data) || empty($data['files'])) {
        return false;
    }
    return $data;
}

function localpoc_delete_job($job_id) {
    delete_transient('localpoc_job_' . $job_id);
}

function localpoc_get_manifest_slice($job_id, $offset, $limit) {
    try {
        if ($job_id) {
            $job = localpoc_get_job($job_id);
            if (!$job) {
                return new WP_Error(
                    'localpoc_job_missing',
                    __('Manifest job not found or expired.', 'localpoc'),
                    ['status' => 404]
                );
            }
            $files = $job['files'];
            $total_files = $job['total_files'] ?? count($files);
            $total_bytes = $job['total_bytes'] ?? array_sum(array_column($files, 'size'));
            $slice = array_slice($files, $offset, $limit);

            return [
                'root'        => ABSPATH,
                'offset'      => $offset,
                'limit'       => $limit,
                'total_files' => $total_files,
                'total_bytes' => $total_bytes,
                'files'       => array_values($slice),
                'job_id'      => $job_id,
            ];
        }

        $manifest = localpoc_generate_manifest($offset, $limit);
        $job_id = localpoc_save_job($manifest['all_files']);
        unset($manifest['all_files']);
        $manifest['job_id'] = $job_id;
        return $manifest;
    } catch (UnexpectedValueException $e) {
        return new WP_Error(
            'localpoc_manifest_error',
            __('Unable to build file manifest.', 'localpoc'),
            ['status' => 500]
        );
    }
}

function localpoc_resolve_relative_path($relative_path) {
    $relative_path = (string) $relative_path;
    $relative = ltrim(str_replace('\\', '/', $relative_path), '/');
    if ($relative === '') {
        return new WP_Error(
            'localpoc_invalid_path',
            __('Invalid file path.', 'localpoc'),
            ['status' => 400]
        );
    }

    $root_realpath = realpath(ABSPATH);
    if ($root_realpath === false) {
        return new WP_Error(
            'localpoc_root_unavailable',
            __('Unable to determine site root.', 'localpoc'),
            ['status' => 500]
        );
    }

    $full_path = $root_realpath . DIRECTORY_SEPARATOR . str_replace('/', DIRECTORY_SEPARATOR, $relative);
    $resolved_path = realpath($full_path);

    if ($resolved_path === false) {
        return new WP_Error(
            'localpoc_file_not_found',
            __('Requested file not found.', 'localpoc'),
            ['status' => 404]
        );
    }

    $normalized_root = wp_normalize_path($root_realpath);
    $normalized_resolved = wp_normalize_path($resolved_path);
    if (strpos($normalized_resolved . '/', trailingslashit($normalized_root)) !== 0) {
        return new WP_Error(
            'localpoc_invalid_path',
            __('Invalid file path.', 'localpoc'),
            ['status' => 400]
        );
    }

    if (!is_readable($resolved_path)) {
        return new WP_Error(
            'localpoc_unreadable_file',
            __('File is not readable.', 'localpoc'),
            ['status' => 403]
        );
    }

    return $resolved_path;
}

function localpoc_normalize_relative_path($path) {
    $path = (string) $path;
    $path = ltrim(str_replace('\\', '/', $path), '/');
    return $path;
}

function localpoc_prepare_batch_files(array $paths) {
    $files = [];
    foreach ($paths as $path) {
        if (!is_string($path) || $path === '') {
            continue;
        }
        $relative = localpoc_normalize_relative_path($path);
        if ($relative === '') {
            continue;
        }
        $resolved = localpoc_resolve_relative_path($relative);
        if ($resolved instanceof WP_Error || !is_file($resolved)) {
            continue;
        }
        $files[] = [
            'relative' => $relative,
            'resolved' => $resolved,
        ];
    }

    return $files;
}

function localpoc_normalize_paths_input($payload) {
    if (!is_array($payload)) {
        return new WP_Error(
            'localpoc_bad_request',
            __('Invalid payload.', 'localpoc'),
            ['status' => 400]
        );
    }

    $paths = $payload['paths'] ?? [];
    if (!is_array($paths) || empty($paths)) {
        return new WP_Error(
            'localpoc_no_files',
            __('No paths provided.', 'localpoc'),
            ['status' => 400]
        );
    }

    return $paths;
}

function localpoc_stream_zip_archive(array $files, $filename = 'localpoc-batch.zip') {
    if (!class_exists('ZipArchive')) {
        return new WP_Error(
            'localpoc_zip_missing',
            __('ZipArchive extension is required.', 'localpoc'),
            ['status' => 500]
        );
    }

    $tmp = wp_tempnam('localpoc-batch');
    $zip = new ZipArchive();
    if ($zip->open($tmp, ZipArchive::OVERWRITE) !== true) {
        @unlink($tmp);
        return new WP_Error(
            'localpoc_zip_failed',
            __('Unable to create zip archive.', 'localpoc'),
            ['status' => 500]
        );
    }

    foreach ($files as $file) {
        $zip->addFile($file['resolved'], $file['relative']);
    }
    $zip->close();

    if (!headers_sent()) {
        header('Content-Type: application/zip');
        header('Content-Disposition: attachment; filename="' . addslashes($filename) . '"');
        header('Content-Length: ' . filesize($tmp));
        header('Cache-Control: no-store, no-transform');
    }

    $output = fopen('php://output', 'wb');
    $input = fopen($tmp, 'rb');
    stream_copy_to_stream($input, $output);
    fclose($input);
    fclose($output);
    @unlink($tmp);

    exit;
}

/** Registers REST routes for clients expecting /wp-json endpoints. */
function localpoc_register_rest_routes() {
    register_rest_route(
        'localpoc/v1',
        '/files-manifest',
        [
            'methods'             => WP_REST_Server::READABLE,
            'callback'            => 'localpoc_rest_files_manifest',
            'permission_callback' => '__return_true',
        ]
    );

    register_rest_route(
        'localpoc/v1',
        '/job/init',
        [
            'methods'             => WP_REST_Server::CREATABLE,
            'callback'            => 'localpoc_rest_job_init',
            'permission_callback' => '__return_true',
        ]
    );

    register_rest_route(
        'localpoc/v1',
        '/job/finish',
        [
            'methods'             => WP_REST_Server::CREATABLE,
            'callback'            => 'localpoc_rest_job_finish',
            'permission_callback' => '__return_true',
        ]
    );

    register_rest_route(
        'localpoc/v1',
        '/db-meta',
        [
            'methods'             => WP_REST_Server::READABLE,
            'callback'            => 'localpoc_rest_db_meta',
            'permission_callback' => '__return_true',
        ]
    );

    register_rest_route(
        'localpoc/v1',
        '/files/batch-zip',
        [
            'methods'             => WP_REST_Server::CREATABLE,
            'callback'            => 'localpoc_rest_files_batch_zip',
            'permission_callback' => '__return_true',
        ]
    );
}

/** REST handler for paginated manifest. */
function localpoc_rest_files_manifest(WP_REST_Request $request) {
    $key = $request->get_header('x-localpoc-key');
    if (empty($key)) {
        $key = $request->get_param('localpoc_key');
    }

    $auth_result = localpoc_validate_access_key($key);
    if ($auth_result instanceof WP_Error) {
        return $auth_result;
    }

    [$offset, $limit] = localpoc_normalize_pagination($request->get_param('offset'), $request->get_param('limit'));
    $job_id = $request->get_param('job_id');

    $manifest = localpoc_get_manifest_slice($job_id, $offset, $limit);
    if ($manifest instanceof WP_Error) {
        return $manifest;
    }

    return rest_ensure_response($manifest);
}

/** Returns a recursive file manifest for the WordPress root. */
function localpoc_ajax_files_manifest() {
    $auth_result = localpoc_validate_access_key(localpoc_get_request_key());
    if ($auth_result instanceof WP_Error) {
        localpoc_ajax_send_error($auth_result);
    }

    $offset = isset($_REQUEST['offset']) ? (int) $_REQUEST['offset'] : 0; // phpcs:ignore
    $limit = isset($_REQUEST['limit']) ? (int) $_REQUEST['limit'] : 5000; // phpcs:ignore
    [$offset, $limit] = localpoc_normalize_pagination($offset, $limit);

    $job_id = isset($_REQUEST['job_id']) ? sanitize_text_field(wp_unslash($_REQUEST['job_id'])) : ''; // phpcs:ignore
    $manifest = localpoc_get_manifest_slice($job_id, $offset, $limit);
    if ($manifest instanceof WP_Error) {
        localpoc_ajax_send_error($manifest);
    }

    wp_send_json($manifest);
}

function localpoc_ajax_files_batch_zip() {
    $auth_result = localpoc_validate_access_key(localpoc_get_request_key());
    if ($auth_result instanceof WP_Error) {
        localpoc_ajax_send_error($auth_result);
    }

    $payload = localpoc_get_json_body();
    if ($payload instanceof WP_Error) {
        localpoc_ajax_send_error($payload);
    }

    $paths = localpoc_normalize_paths_input($payload);
    if ($paths instanceof WP_Error) {
        localpoc_ajax_send_error($paths);
    }

    $files = localpoc_prepare_batch_files($paths);
    if (empty($files)) {
        localpoc_ajax_send_error(new WP_Error(
            'localpoc_no_files',
            __('No valid files to include.', 'localpoc'),
            ['status' => 400]
        ));
    }

    $result = localpoc_stream_zip_archive($files);
    if ($result instanceof WP_Error) {
        localpoc_ajax_send_error($result);
    }
}

function localpoc_rest_files_batch_zip(WP_REST_Request $request) {
    $key = $request->get_header('x-localpoc-key');
    if (empty($key)) {
        $key = $request->get_param('localpoc_key');
    }

    $auth_result = localpoc_validate_access_key($key);
    if ($auth_result instanceof WP_Error) {
        return $auth_result;
    }

    $payload = $request->get_json_params();
    $paths = localpoc_normalize_paths_input($payload);
    if ($paths instanceof WP_Error) {
        return $paths;
    }

    $files = localpoc_prepare_batch_files($paths);
    if (empty($files)) {
        return new WP_Error(
            'localpoc_no_files',
            __('No valid files to include.', 'localpoc'),
            ['status' => 400]
        );
    }

    $result = localpoc_stream_zip_archive($files);
    if ($result instanceof WP_Error) {
        return $result;
    }
}

function localpoc_create_manifest_job($mode = 'default') {
    // TODO: support asynchronous scan modes via $mode parameter.
    try {
        $files = localpoc_scan_file_list();
    } catch (UnexpectedValueException $e) {
        return new WP_Error(
            'localpoc_manifest_error',
            __('Unable to build file manifest.', 'localpoc'),
            ['status' => 500]
        );
    }

    $job_id = localpoc_save_job($files);
    $job = localpoc_get_job($job_id);

    return [
        'job_id'      => $job_id,
        'total_files' => $job['total_files'] ?? count($files),
        'total_bytes' => $job['total_bytes'] ?? array_sum(array_column($files, 'size')),
        'created_at'  => $job['created_at'],
    ];
}

function localpoc_ajax_job_init() {
    $auth_result = localpoc_validate_access_key(localpoc_get_request_key());
    if ($auth_result instanceof WP_Error) {
        localpoc_ajax_send_error($auth_result);
    }

    $mode = isset($_REQUEST['mode']) ? sanitize_text_field(wp_unslash($_REQUEST['mode'])) : 'default'; // phpcs:ignore
    $result = localpoc_create_manifest_job($mode);
    if ($result instanceof WP_Error) {
        localpoc_ajax_send_error($result);
    }

    wp_send_json($result);
}

function localpoc_rest_job_init(WP_REST_Request $request) {
    $key = $request->get_header('x-localpoc-key');
    if (empty($key)) {
        $key = $request->get_param('localpoc_key');
    }

    $auth_result = localpoc_validate_access_key($key);
    if ($auth_result instanceof WP_Error) {
        return $auth_result;
    }

    $mode = $request->get_param('mode') ?: 'default';
    $result = localpoc_create_manifest_job($mode);
    if ($result instanceof WP_Error) {
        return $result;
    }

    return rest_ensure_response($result);
}

function localpoc_finish_manifest_job($job_id) {
    if (empty($job_id)) {
        return new WP_Error(
            'localpoc_job_missing',
            __('Manifest job ID is required.', 'localpoc'),
            ['status' => 400]
        );
    }

    localpoc_delete_job($job_id);
    return true;
}

function localpoc_ajax_job_finish() {
    $auth_result = localpoc_validate_access_key(localpoc_get_request_key());
    if ($auth_result instanceof WP_Error) {
        localpoc_ajax_send_error($auth_result);
    }

    $job_id = isset($_REQUEST['job_id']) ? sanitize_text_field(wp_unslash($_REQUEST['job_id'])) : ''; // phpcs:ignore
    $result = localpoc_finish_manifest_job($job_id);
    if ($result instanceof WP_Error) {
        localpoc_ajax_send_error($result);
    }

    wp_send_json(['ok' => true]);
}

function localpoc_rest_job_finish(WP_REST_Request $request) {
    $key = $request->get_header('x-localpoc-key');
    if (empty($key)) {
        $key = $request->get_param('localpoc_key');
    }

    $auth_result = localpoc_validate_access_key($key);
    if ($auth_result instanceof WP_Error) {
        return $auth_result;
    }

    $job_id = $request->get_param('job_id');
    $result = localpoc_finish_manifest_job($job_id);
    if ($result instanceof WP_Error) {
        return $result;
    }

    return rest_ensure_response(['ok' => true]);
}

function localpoc_get_db_meta_data() {
    global $wpdb;

    $status = $wpdb->get_results('SHOW TABLE STATUS', ARRAY_A);
    $tables = [];
    $total_rows = 0;
    $total_bytes = 0;

    foreach ((array) $status as $row) {
        $name = $row['Name'];
        $rows = (int) $row['Rows'];
        $bytes = (int) $row['Data_length'] + (int) $row['Index_length'];
        $tables[] = [
            'name'         => $name,
            'rows'         => $rows,
            'approx_bytes' => $bytes,
        ];
        $total_rows += $rows;
        $total_bytes += $bytes;
    }

    return [
        'tables'             => $tables,
        'total_rows'         => $total_rows,
        'total_approx_bytes' => $total_bytes,
    ];
}

function localpoc_rest_db_meta(WP_REST_Request $request) {
    $key = $request->get_header('x-localpoc-key');
    if (empty($key)) {
        $key = $request->get_param('localpoc_key');
    }

    $auth_result = localpoc_validate_access_key($key);
    if ($auth_result instanceof WP_Error) {
        return $auth_result;
    }

    return rest_ensure_response(localpoc_get_db_meta_data());
}

function localpoc_ajax_db_meta() {
    $auth_result = localpoc_validate_access_key(localpoc_get_request_key());
    if ($auth_result instanceof WP_Error) {
        localpoc_ajax_send_error($auth_result);
    }

    wp_send_json(localpoc_get_db_meta_data());
}

/** Streams an individual file from the site filesystem. */
function localpoc_ajax_file() {
    $auth_result = localpoc_validate_access_key(localpoc_get_request_key());
    if ($auth_result instanceof WP_Error) {
        localpoc_ajax_send_error($auth_result);
    }

    $relative_path = isset($_REQUEST['path']) ? sanitize_text_field(wp_unslash($_REQUEST['path'])) : '';
    if ($relative_path === '') {
        localpoc_ajax_send_error(new WP_Error(
            'localpoc_invalid_path',
            __('File path is required.', 'localpoc'),
            ['status' => 400]
        ));
    }

    $resolved_path = localpoc_resolve_relative_path($relative_path);
    if ($resolved_path instanceof WP_Error) {
        localpoc_ajax_send_error($resolved_path);
    }

    $filesize = filesize($resolved_path);
    $basename = basename($resolved_path);

    if (function_exists('set_time_limit')) {
        @set_time_limit(0);
    }

    if (!headers_sent()) {
        header('Content-Type: application/octet-stream');
        if ($filesize !== false) {
            header('Content-Length: ' . $filesize);
        }
        header('Content-Disposition: attachment; filename="' . addslashes($basename) . '"');
        header('Cache-Control: no-store, no-transform');
    }

    $handle = fopen($resolved_path, 'rb');
    if (!$handle) {
        localpoc_ajax_send_error(new WP_Error(
            'localpoc_stream_error',
            __('Unable to open file for reading.', 'localpoc'),
            ['status' => 500]
        ));
    }

    $output = fopen('php://output', 'wb');
    if ($output === false) {
        fclose($handle);
        localpoc_ajax_send_error(new WP_Error(
            'localpoc_stream_error',
            __('Unable to open output stream.', 'localpoc'),
            ['status' => 500]
        ));
    }

    if (function_exists('set_time_limit')) {
        @set_time_limit(0);
    }

    if (stream_copy_to_stream($handle, $output) === false) {
        fclose($handle);
        fclose($output);
        localpoc_ajax_send_error(new WP_Error(
            'localpoc_stream_error',
            __('Unable to stream file.', 'localpoc'),
            ['status' => 500]
        ));
    }

    fclose($handle);
    fclose($output);
    exit;

    // Fallback return for completeness; normally unreachable due to exit above.
    return rest_ensure_response([
        'message' => 'File stream completed.',
    ]);
}

/** Streams a lightweight SQL export of the WordPress database. */
function localpoc_ajax_db_stream() {
    $auth_result = localpoc_validate_access_key(localpoc_get_request_key());
    if ($auth_result instanceof WP_Error) {
        localpoc_ajax_send_error($auth_result);
    }

    global $wpdb;

    if (!$wpdb instanceof wpdb) {
        localpoc_ajax_send_error(new WP_Error(
            'localpoc_db_unavailable',
            __('Database connection unavailable.', 'localpoc'),
            ['status' => 500]
        ));
    }

    $tables = $wpdb->get_col('SHOW TABLES');
    if (!is_array($tables)) {
        localpoc_ajax_send_error(new WP_Error(
            'localpoc_db_list_failed',
            __('Unable to list database tables.', 'localpoc'),
            ['status' => 500]
        ));
    }

    if (function_exists('nocache_headers')) {
        nocache_headers();
    }

    if (function_exists('set_time_limit')) {
        @set_time_limit(0);
    }

    if (!headers_sent()) {
        header('Content-Type: text/plain; charset=' . get_option('blog_charset'));
        header('Content-Disposition: attachment; filename="localpoc-backup.sql"');
        header('Cache-Control: no-store, no-transform');
    }

    echo "-- LocalPOC database export generated at " . current_time('mysql') . "\n\n";

    foreach ($tables as $table_name) {
        localpoc_stream_table_structure($table_name, $wpdb);
        localpoc_stream_table_rows($table_name, $wpdb);
    }

    exit;
}

/** Outputs CREATE TABLE statements for a given table. */
function localpoc_stream_table_structure($table_name, wpdb $wpdb) {
    $safe_table = localpoc_quote_identifier($table_name);
    $create = $wpdb->get_row("SHOW CREATE TABLE {$safe_table}", ARRAY_N);

    echo "\n-- Table: {$table_name}\n";
    echo "DROP TABLE IF EXISTS {$safe_table};\n";

    if (is_array($create) && isset($create[1])) {
        echo $create[1] . ";\n\n";
    } else {
        error_log('localpoc: Failed to fetch CREATE TABLE for ' . $table_name);
        echo "-- Unable to fetch CREATE TABLE for {$table_name}\n\n";
    }
}

/** Streams INSERT statements for all rows in the given table. */
function localpoc_stream_table_rows($table_name, wpdb $wpdb) {
    $safe_table = localpoc_quote_identifier($table_name);
    $chunk_size = 200;
    $cursor = localpoc_get_table_cursor_info($table_name, $wpdb);
    $lastValue = null;
    $use_cursor = $cursor !== null;
    $offset = 0;

    do {
        if ($use_cursor) {
            if ($lastValue === null) {
                $sql = $wpdb->prepare("SELECT * FROM {$safe_table} ORDER BY {$cursor['quoted']} ASC LIMIT %d", $chunk_size);
            } else {
                if ($cursor['numeric']) {
                    $sql = $wpdb->prepare("SELECT * FROM {$safe_table} WHERE {$cursor['quoted']} > %d ORDER BY {$cursor['quoted']} ASC LIMIT %d", $lastValue, $chunk_size);
                } else {
                    $sql = $wpdb->prepare("SELECT * FROM {$safe_table} WHERE {$cursor['quoted']} > %s ORDER BY {$cursor['quoted']} ASC LIMIT %d", $lastValue, $chunk_size);
                }
            }
        } else {
            $sql = $wpdb->prepare("SELECT * FROM {$safe_table} LIMIT %d OFFSET %d", $chunk_size, $offset);
        }

        $rows = $wpdb->get_results($sql, ARRAY_A);

        if ($rows === null) {
            error_log('localpoc: Failed to select rows for ' . $table_name . ' - ' . $wpdb->last_error);
            echo "-- Error exporting rows for {$table_name}\n";
            break;
        }

        if (empty($rows)) {
            break;
        }

        $batch = [];
        foreach ($rows as $row) {
            $values = [];
            foreach ($row as $value) {
                $values[] = localpoc_escape_sql_value($value);
            }

            $batch[] = '(' . implode(', ', $values) . ')';

            if (count($batch) >= 50) {
                echo 'INSERT INTO ' . $safe_table . ' VALUES ' . implode(",\n", $batch) . ";\n";
                $batch = [];
            }
        }

        if (!empty($batch)) {
            echo 'INSERT INTO ' . $safe_table . ' VALUES ' . implode(",\n", $batch) . ";\n";
        }

        if ($use_cursor) {
            $last = end($rows);
            $lastValue = $last[$cursor['column']];
        } else {
            $offset += count($rows);
        }

        if (function_exists('ob_get_level') && ob_get_level() > 0) {
            @ob_flush();
        }
        flush();
    } while (count($rows) === $chunk_size);
}

function localpoc_get_table_cursor_info($table_name, wpdb $wpdb) {
    $safe_table = localpoc_quote_identifier($table_name);
    $primary = $wpdb->get_results("SHOW KEYS FROM {$safe_table} WHERE Key_name = 'PRIMARY'", ARRAY_A);
    $column = '';
    if (!empty($primary)) {
        $unique_columns = array_unique(array_column($primary, 'Column_name'));
        if (count($unique_columns) === 1) {
            $column = $unique_columns[0];
        }
    }

    $columns = $wpdb->get_results("SHOW COLUMNS FROM {$safe_table}", ARRAY_A);
    if (empty($column) && is_array($columns)) {
        foreach ($columns as $col_info) {
            if (isset($col_info['Extra']) && stripos($col_info['Extra'], 'auto_increment') !== false) {
                $column = $col_info['Field'];
                break;
            }
        }
    }

    if (empty($column)) {
        return null;
    }

    $type = '';
    if (is_array($columns)) {
        foreach ($columns as $col_info) {
            if ($col_info['Field'] === $column) {
                $type = strtolower($col_info['Type']);
                break;
            }
        }
    }

    return [
        'column' => $column,
        'quoted' => localpoc_quote_identifier($column),
        'numeric' => (bool) preg_match('/int|decimal|float|double|bit/', $type),
    ];
}

/** Escapes SQL values for direct output. */
function localpoc_escape_sql_value($value) {
    if ($value === null) {
        return 'NULL';
    }

    if (is_bool($value)) {
        return $value ? '1' : '0';
    }

    if (is_int($value) || is_float($value)) {
        return (string) $value;
    }

    $escaped = addslashes((string) $value);
    $escaped = str_replace(["\r", "\n"], ['\\r', '\\n'], $escaped);

    return "'{$escaped}'";
}

/** Quotes a table name for SQL output. */
function localpoc_quote_identifier($identifier) {
    $safe = str_replace('`', '``', $identifier);
    return "`{$safe}`";
}

// Initialize the plugin
LocalPOC_Plugin::init();
